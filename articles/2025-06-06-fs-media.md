---
title: "pico-jxglib で Pico ボードに SDCard や USB ストレージを接続する話"
emoji: "🙆"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["組み込み", "raspberrypi", "pico", "raspberrypipico", "usb"]
published: false
---
**pico-jxglib** は、ワンボードマイコン Raspberry Pi Pico の Pico SDK プログラミングをサポートするライブラリです。

https://zenn.dev/ypsitau/articles/2025-01-24-jxglib-intro


今回は、Pico ボードに SDCard や USB ストレージを接続してファイルシステムとして使えるようにします。フラッシュメモリをファイルシステムにする方法については以下の記事を参照してください。

[pico-jxglib で Pico ボードにファイルシステムを実装してフラッシュメモリをフル活用する話](https://zenn.dev/ypsitau/articles/2025-05-31-fs-flash)

## SDCard について

SDCard はスマートフォンでも使われているおなじみのストレージで、コンビニエンスストアでも手に入るほど身近な存在です。それだけに、組込みデバイスに接続するのも簡単だろうと思いがちですが、実はそうでもありません。ここでは、SDCard の接続方法や、ソフトウェアの注意点について解説します。

### SDCard の接続方法

SDCard の接続方法や制御方法については以下のサイトに詳しい情報があります。

[MMC/SDC の使い方](https://elm-chan.org/docs/mmc/mmc.html)

接続の際には、以下のことがらを最低限確認しておく必要があります。

- SDCard の電源は **3.3V** です
- SDCard の信号線はプルアップ抵抗が必要です

SDCard のインターフェース回路は SDCard それ自体に組み込まれているので、SDCard のピンを直接ボードに接続して使用することもできます。でも、リムーバブルメディアとしての使い勝手を考えると、ごく自然にアダプタを使うことになるでしょう。ここで問題になるのは、アダプタの種類と接続方法です。SDCard アダプタは、基本的に SDCard スロットといくつかの抵抗や三端子レギュレータが載っているだけのシンプルなものですが、与える電圧や信号のレベル、プルアップ抵抗の有無などがアダプタによって異なるので注意が必要です。

以下、手元にある SDCard アダプタ (主に Amazon で入手) ごとに接続方法を確認していきます。




### SDCard 制御ソフトウェアについて

SDCard の制御ソフトウェアは、SDCard の SPI モードと SDIO モードの二つのモードをサポートしています。SPI モードは、SDCard を SPI インターフェースで接続するためのモードで、SDIO モードは SDCard のネイティブなインターフェースで接続するためのモードです。SDIO の方が高速で SDCard の機能をフルに活用できますが、Pico ボードで動かしている例はとても少ないです。**pico-jxglib** では実装例の豊富な SPI モードをサポートしています。

SDCard はカード自体にインターフェース回路を内蔵していますが、このことは SDCard ごとに微妙に異なるインターフェース仕様が存在していることを意味します。そのためドライバを作成しても、いろいろな SDCard で動作実績をつまないと実際に使えるものにはなりません。そこで、多くのユーザが使っているであろう[MicroPython の SDCard ドライバ](https://github.com/micropython/micropython-lib/blob/master/micropython/drivers/storage/sdcard/sdcard.py)を C++ で書き換えて、それをベースにライブラリに組み込ました。これで汎用性の高いプログラムになっているとよいのですが...。なにはともあれ、MicroPython さんには感謝です。

## USB ストレージについて

Pico ボードでは USB ホスト機能を使って USB ストレージを接続することができます。tinyusb ライブラリで用意されている Mass Storage Class を使ってファイルシステムに USB ストレージのハンドラを実装しています。

## 実際のプロジェクト

### 開発環境のセットアップ

Visual Studio Code や Git ツール、Pico SDK のセットアップが済んでいない方は[「Pico SDK ことはじめ」](https://zenn.dev/ypsitau/articles/2025-01-17-picosdk#%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83) をご覧ください。

GitHub から **pico-jxglib** をクローンします。

```bash
git clone https://github.com/ypsitau/pico-jxglib.git
cd pico-jxglib
git submodule update --init
```

:::message
**pico-jxglib** はほぼ毎日更新されています。すでにクローンしている場合は、`pico-jxglib` ディレクトリで以下のコマンドを実行して最新のものにしてください。

```bash
git pull
```

:::

### プロジェクトの作成

VSCode のコマンドパレットから `>Raspberry Pi Pico: New Pico Project` を実行し、以下の内容でプロジェクトを作成します。Pico SDK プロジェクト作成の詳細や、ビルド、ボードへの書き込み方法については[「Pico SDK ことはじめ」](https://zenn.dev/ypsitau/articles/2025-01-17-picosdk#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90%E3%81%A8%E7%B7%A8%E9%9B%86) を参照ください。

- **Name** ... プロジェクト名を入力します。今回は例として `fs-media` を入力します
- **Board type** ... ボード種別を選択します
- **Location** ... プロジェクトディレクトリを作る一つ上のディレクトリを選択します
- **Stdio support** .. Stdio に接続するポート (UART または USB) を選択します
- **Code generation options** ... **`Generate C++ code` にチェックをつけます**

プロジェクトディレクトリと `pico-jxglib` のディレクトリ配置が以下のようになっていると想定します。

```text
├── pico-jxglib/
└── fs-media/
    ├── CMakeLists.txt
    ├── fs-media.cpp
    └── ...
```

以下、このプロジェクトをもとに `CMakeLists.txt` やソースファイルを編集してプログラムを作成していきます。

### SDCard の接続



### USB ストレージの接続
