---
title: "テキストベースも負けていない! プロトコルデコードもできる la コマンドはとても便利"
emoji: "📚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["raspberrypi", "pico", "raspberrypipico", "ロジックアナライザ", "プロトコルデコーダ"]
published: false
---
[pico-jxgLABO](https://zenn.dev/ypsitau/articles/2025-08-01-labo-intro) は、USB ケーブル一本でマイコンボード RaspberryPi Pico の様々な機能を試すことができる実験プラットフォームです。

この記事では、pico-jxgLABO のロジックアナライザコマンド `la` の機能を紹介します。このコマンド自体はテキストベースですが、GUI ツール PulseView と連携することで詳細な波形解析ができますし、コマンド単体でも I2C や SPI、PWM などのプロトコルデコードが可能です。

## pico-jxgLABO の書き込み

Pico ボードへの pico-jxgLABO の書き込みと基本的な使い方は[こちら](https://zenn.dev/ypsitau/articles/2025-08-01-labo-intro#pico-jxglabo-%E3%81%AE%E5%B0%8E%E5%85%A5%E6%96%B9%E6%B3%95)。特別なハードウェアは必要なく、Pico や Pico 2 ボードを USB ケーブルで PC に接続するだけで始められます。

この記事で説明する実験を行うには、バージョン `0.2.0` 以降の pico-jxgLABO が Pico ボードに書き込まれている必要があります。ターミナルソフトで `about-me` コマンドを実行すると pico-jxgLABO のバージョンを確認できます。

```text
L:/>about-me
Program Information
 name:              pico-jxgLABO
 version:           0.2.0
     :
     :
```

## `la` コマンドの機能

`la` コマンドの動作は大きく分けて二つあり、一つはデータサンプリング、もう一つは波形表示および解析です。データサンプリングで信号データをメモリにとりこみ、そのメモリ内容を参照して波形表示や解析を行うという流れになります。

### データサンプリング

#### サンプリングの開始と停止

`la` コマンドの `-p` (または `--pins`) オプションで測定する GPIO ピンを指定し、`enable` サブコマンドを実行することでサンプリングを開始します。

```text
L:/>la -p 2,3,4 enable
```

GPIO ピンはピン番号をカンマで区切って指定します。ハイフンを使って範囲指定をすることもできます。以下の表に例を示します。

|GPIO ピン指定 |内容                             |
|-------------|---------------------------------|
|`-p 0`       |GPIO0 を指定します                |
|`-p 2,3,8,9` |GPIO2,3,8,9 を指定します          |
|`-p 8-15`    |GPIO8 から GPIO15 までを指定します |
|`-p 2-4,8-13`|GPIO2 から GPIO4、GPIO8 から GPIO13 までを指定します|

このオプションで指定した GPIO ピンの情報は、`la` コマンドや PulseView での波形表示にも反映されます。

`la` コマンドは、データ格納用のバッファメモリを確保した後、PIO (Programmable Input/Output) と DMA (Direct Memory Access) に対してサンプリング処理を指示してすぐに終了します。実際の処理はこれら PIO と DMA が行うので、**CPU 負荷はゼロ**です。

`la` コマンドで `disable` サブコマンドを実行するとサンプリングを停止し、PIO、DMA およびバッファメモリのリソースを解放します。

```text
L:/>la disable
```

サンプリングを最初からやり直す場合は `enable` サブコマンドを実行します。`disable` を明示的に実行する必要はありません。また、GPIO ピンなどの指定は前回の設定が引き継がれるので、変更がなければ `enable` だけ実行すれば大丈夫です。

```text
L:/>la enable
```

なお、PulseView で `Start` ボタンを押すと、内部的に `la enable` コマンド相当の処理が行われます。

#### サンプリングモードについて

pico-jxgLABO のロジックアナライザは、transitional モードでサンプリング処理を行います。transitional モードでは、信号が変化したときだけデータをサンプリングするので、メモリバッファを効率的に使用できます。また、信号の変化が速い (高周波) の場合でも、遅い (低周波) の場合でも、同じサンプリングレートでサンプリングできます。

#### 内部信号と外部信号の選択

`--target` オプションでサンプリング対象を指定できます。`internal` (デフォルト) を指定すると Pico 内部の信号を、`external` を指定すると GPIO ピンに入力された外部信号をサンプリングします。

- `--target:internal` Pico 内部の信号をサンプリングします
- `--target:external` GPIO ピンに入力された外部信号をサンプリングします

`--target` オプションはすべての GPIO ピンを一括で設定しますが、以下のオプションを使うことで GPIO ピン毎に設定を変更することができます。

- `--internal:PINS` 内部信号のサンプリングをする GPIO ピンを指定します
- `--external:PINS` 外部信号のサンプリングをする GPIO ピンを指定します
- `--inherited:PINS` `--target` オプションの設定を引き継ぐ GPIO ピンを指定します

#### サンプリングレートの指定

pico-jxgLABO は PIO のステートマシンを使ってサンプリング処理を行います。このサンプリング処理を行うステートマシンのことを、ここではサンプラーと呼びます。

サンプラーが一つのデータのサンプリングをするのに必要なクロック数は 12 クロックです。つまり、クロック周波数 150MHz の Pico2 の場合、150MHz ÷ 12 = 12.5MHz のサンプリングが可能です。Pico (クロック周波数 125MHz) の場合は、125MHz ÷ 12 = 10.4MHz のサンプリングが可能になります。

ひとつの PIO ブロックには 4 個のステートマシン (サンプラー) が搭載されています。これらを開始時刻をずらして並行動作させることで、サンプリングレートを上げることができます。動作させるサンプラーの数はオプション `--samplers` で指定します。以下に例を示します。

|コマンド　        |サンプリングレート                 |
|-----------------|---------------------------------|
|`--samplers:1`   |12.5MHz (Pico2), 10.4MHz (Pico)  |
|`--samplers:2`   |25.0MHz (Pico2), 20.8MHz (Pico)  |
|`--samplers:3`   |37.5MHz (Pico2), 31.2MHz (Pico)  |
|`--samplers:4`   |50.0MHz (Pico2), 41.7MHz (Pico)  |

サンプラーの数を増やすとサンプリングレートが上がりますが、サンプリングできるイベントの数が減ります。

#### 使用する PIO の指定

Pico2 は PIO0, PIO1, PIO2 の 3 ブロック、Pico は PIO0 と PIO1 の 2 ブロックを搭載しています。デフォルトでは、PIO2 (Pico2) または PIO1 (Pico) をロジックアナライザ用に使用しますが、`--pio` オプションで使用する PIO ブロックを指定できます。以下に例を示します。

- `--pio:0` PIO0 を使用します
- `--pio:1` PIO1 を使用します
- `--pio:2` PIO2 を使用します

#### メモリバッファのサイズ指定

`--help-ratio` オプションでメモリバッファのサイズを指定できます。デフォルトは `0.7` で、使用可能なヒープ領域の 70% をバッファとして使用します。他の用途でヒープ領域が足りない場合は、この数値を小さくしてください。

### 波形表示および解析

PulseView を使う場合は、波形表示や解析は GUI ツール上で行われるので `la` コマンドで特別な操作をする必要はありません。ここでは、`la` コマンド単体で行う波形表示および解析について説明します。

#### 波形表示


#### 波形解析


